/*
 * main.c
 * Date Created: 10/30/2018
 */

#include "headers.h"

/*
 * Function to print program usage information
 */
void usage()
{
    char *usage_str = "This program is used to scan your linux system for malware. \n"
                       " \n"
                       "Usage: \n"
                       "    $ ./main \n"
                       "    $ ./main [-f|--find] <process_name>\n"
                       "Options: \n"
                       "    -f --find   Define a process name to find. \n"
                       "    \n";
                        
    printf("%s", usage_str);
    
}

/*
 * Main function
 */
int main(int argc, char *argv[])
{

    // Load the kernel module
    int status;
    status = system("./load_module.sh");

    // Check if module loaded successfully
    if (status != 0) {
        printf("Failed to load the kernel module.\n");
        system("./unload_module.sh");
        exit(-1);
    }
    
    // Parse command line arguments
    int i;
    for (i = 1; i < argc; i++) {
        
        // Display program usage and exit
        if ((strcmp(argv[i],"-h") == 0) || (strcmp(argv[i],"--help") == 0)) {
            usage();
            
            // Unload the kernel module
            status = system("./unload_module.sh");
            
            // Exit with status 100
            return 100;

        // Find a process with a given name
    	} else if ((strcmp(argv[i],"--find") == 0) || (strcmp(argv[i],"-f") == 0)) {

            // Load in the process name
            i++;
            char *process_to_find = argv[i];

            // Load input into a buffer to pass to the system call
    		printf("Checking for process %s...\n", process_to_find);
            char buffer[40];
            snprintf(buffer, sizeof(buffer), "%s", process_to_find);

            // Make the system call
            ulong process_pid = syscall(PROCESS_NAME_SYSCALL, buffer);

            // Check the result of the system call
            if (process_pid == 0) {
                // Returns 0 if process is not found
                printf("Process %s not found.\n", process_to_find);
            } else if (process_pid == -1) {
                // Returns -1 if system call was unsuccessful
                printf("System call failed...\n");
                printf("Did you load the kernel module?\n");
            } else {
                // If result is not 0 or -1 a valid pid was returned
                printf("Process %s found with pid %li\n", process_to_find, process_pid);
            }
            
        // Invalid argument provided
    	} else {
            printf("Unknown argument %s.\n", argv[i]);
    		printf("For help type: -h or --help\n");
            
            // Unload the kernel module and exit
            status = system("./unload_module.sh");
            exit(1);
    	}
    }
    
    // Run in interactive mode if no command line arguments are given
    if (argc < 2) {

        // Create the thread for command_line.c
        pthread_attr_t attr;
        pthread_attr_init(&attr);
        pthread_t command_line_t;
        pthread_create(&command_line_t, &attr, parse_commands, NULL);
        
        // Wait for the thread to finish
        pthread_join(command_line_t, NULL);
    }

    // Unload the kernel module
    status = system("./unload_module.sh");
    // Check if module was successfully unloaded
    if (status != 0) {
        printf("Failed to unload the kernel module.\n");
        exit(-1);
    }

    // Exit
    return 0;
    
}

