/*
 * main.c
 * Date Created: 10/30/2018
 */

#include "headers.h"

/*
 * Function to print program usage information
 */
void usage()
{
    char *usage_str = "This program is used to scan your linux system for malware. \n"
                       " \n"
                       "Usage: \n"
                       "    $ ./main \n"
                       "    $ ./main [-f|--find] <process_name>\n"
                       "Options: \n"
                       "    -f --find   Define a process name to find. \n"
                       "    \n";
                        
    printf("%s", usage_str);
    
}

/*
 * Main function
 */
int main(int argc, char *argv[])
{
    
    // Parse command line arguments
    int i;
    for (i = 1; i < argc; i++) {
        
        // Display program usage and exit
        if ((strcmp(argv[i],"-h") == 0) || (strcmp(argv[i],"--help") == 0)) {
            usage();
            return 100;

        // Find a process with a given name
    	} else if ((strcmp(argv[i],"--find") == 0) || (strcmp(argv[i],"-f") == 0)) {
            i++;
            char *process_to_find = argv[i];
    		printf("Checking for process %s...\n", process_to_find);
            char buffer[40];
            snprintf(buffer, sizeof(buffer), "%s", process_to_find);
            ulong process_pid = syscall(PROCESS_NAME_SYSCALL, buffer);
            if (process_pid == 0) {
                printf("Process %s not found.\n", process_to_find);
            } else if (process_pid == -1) {
                printf("System call failed...\n");
                printf("Did you load the kernel module?\n");
            } else {
                printf("Process %s found with pid %li\n", process_to_find, process_pid);
            }
            
        // Placeholder
    	} else if ((strcmp(argv[i],"--other") == 0)) {	// placeholders for now 
    		printf("Placeholder text\n"); 
    	}

        // Invalid argument provided
    	else {
            printf("Unknown argument %s.\n", argv[i]);
    		printf("For help type: -h or --help\n");
    	}
    }
    
    // Run in interactive mode if no command line arguments are given
    if (argc < 2) {
        // Create the thread for command_line.c
        pthread_attr_t attr;
        pthread_attr_init(&attr);
        pthread_t command_line_t;
        pthread_create(&command_line_t, &attr, parse_commands, NULL);
        
        // Wait for the thread to finish
        pthread_join(command_line_t, NULL);
    }

    // Exit
    return 0;
    
}

